{% load static %}

<link rel="stylesheet" href="{% static 'simulado/simulado.css' %}">

<div class="simulado-container simulado-questao">

  {% with modo_atual=mode|default:"PROVA" %}
    <h2 class="simulado-titulo">
      Questão {{ idx|add:1 }} de {{ total }}{% if modo_atual != "PROVA" %} ({{ acertos|default:0 }} acertos / {{ erros|default:0 }} erros){% endif %}
    </h2>

    {% if modo_atual != "PROVA" %}
      <p class="simulado-contagem">
        Acertos: {{ acertos|default:0 }} | Erros: {{ erros|default:0 }}
      </p>
    {% endif %}
  {% endwith %}

  <p class="simulado-modulo">
    <strong>{{ questao.modulo.nome }}</strong>
  </p>

  <p class="simulado-enunciado">
    <span class="simulado-enunciado-numero">{{ idx|add:1 }}.</span>
    <span class="simulado-enunciado-texto">{{ questao.enunciado }}</span>
  </p>

  {% if questao.imagem_arquivo %}
    <div class="questao-imagem-questao-wrapper">
      <img
        src="{% static 'placas/' %}{{ questao.imagem_arquivo }}"
        alt="Imagem da questão"
        class="questao-imagem-questao"
        onerror="this.closest('.questao-imagem-questao-wrapper').style.display='none';"
      >
      <small class="questao-imagem-questao-label">
        Arquivo: {{ questao.imagem_arquivo }}
      </small>
    </div>
  {% endif %}

  {% if feedback %}
    {% if feedback.is_correct %}
      <p class="feedback-ok">
        <span class="feedback-icon">&#10003;</span>
        Você acertou!
      </p>
      {% if feedback.selecionada %}
        <p class="feedback-tip"><strong>Sua resposta:</strong> {{ feedback.selecionada.texto }}</p>
      {% endif %}
      {% if feedback.comentario %}
        <p class="feedback-tip"><strong>Comentário:</strong> {{ feedback.comentario }}</p>
      {% endif %}
    {% endif %}
    <div class="feedback {% if feedback.is_correct %}feedback--ok{% else %}feedback--error{% endif %}">
      {% if not feedback.is_correct %}
        {% if feedback.percent_acerto <= 50 %}
          <p class="feedback-error">
            <span class="feedback-icon">&#10007;</span>
            Não foi desta vez, estude mais um pouco.
          </p>
        {% elif feedback.percent_acerto <= 70 %}
          <p class="feedback-error">
            <span class="feedback-icon">&#10007;</span>
            Essa você errou, mas está indo bem, na próxima preste mais atenção na questão.
          </p>
        {% else %}
          <p class="feedback-error">
            <span class="feedback-icon">&#10007;</span>
            Essa você errou, mas caso se esforce mais, irá gabaritar a prova.
          </p>
        {% endif %}
        {% if feedback.selecionada %}
          <p class="feedback-tip"><strong>Sua resposta:</strong> {{ feedback.selecionada.texto }}</p>
        {% endif %}
        {% if feedback.correta %}
          <p class="feedback-tip"><strong>Resposta correta:</strong> {{ feedback.correta.texto }}</p>
        {% endif %}
        {% if feedback.comentario %}
          <p class="feedback-tip"><strong>Comentário:</strong> {{ feedback.comentario }}</p>
        {% endif %}
      {% endif %}
    </div>
    <a class="btn-simulado" href="{{ feedback.next_url }}">
      {% if feedback.is_last %}Ver resultado{% else %}Próxima questão{% endif %}
    </a>
  {% else %}
    <form method="post" action="{% url 'simulado:responder' %}" class="simulado-form">
      {% csrf_token %}

      {% for a in alternativas %}
        <div class="alternativa">
          <label class="alternativa-label">
            <input
              type="radio"
              name="alternativa_id"
              value="{{ a.id }}"
              required
              class="alternativa-radio"
            >
            <span class="alternativa-texto">
              <span class="alternativa-letra">{% cycle 'A)' 'B)' 'C)' 'D)' %}</span>
              {{ a.texto }}
            </span>
          </label>
        </div>
      {% endfor %}

      <button type="submit" class="btn-simulado">
        Responder
      </button>
    </form>
  {% endif %}

</div>

<script id="simulado-imagens" type="application/json">
  {{ imagens_cfg_json|default:"{}"|safe }}
</script>
<script>
  (() => {
    // Aplica config de imagem responsiva a partir do JSON do backend
    const imagensCfg = (() => {
      const el = document.getElementById("simulado-imagens");
      if (!el) return {};
      try {
        return JSON.parse(el.textContent || "{}");
      } catch {
        return {};
      }
    })();

    function applyImagemCfg() {
      const img = document.querySelector(".questao-imagem-questao");
      if (!img) return;
      const w = window.innerWidth || document.documentElement.clientWidth;
      let variant = imagensCfg.desktop || {};
      if (w < 640 && imagensCfg.mobile) {
        variant = imagensCfg.mobile;
      } else if (w < 1024 && imagensCfg.tablet) {
        variant = imagensCfg.tablet;
      }
      const root = document.documentElement;
      if (variant.max_width) {
        root.style.setProperty("--questao-img-max", `${variant.max_width}px`);
      }
      if (variant.padding !== undefined) {
        root.style.setProperty("--questao-img-padding", `${variant.padding}px`);
      }
      if (variant.border_radius !== undefined) {
        root.style.setProperty("--questao-img-radius", `${variant.border_radius}px`);
      }
    }

    applyImagemCfg();
    window.addEventListener("resize", applyImagemCfg);

    const AudioCtx = window.AudioContext || window.webkitAudioContext;
    const ctx = AudioCtx ? new AudioCtx() : null;

    function playTone(freq, duration, type = "sine", volume = 0.08) {
      if (!ctx) return;
      const now = ctx.currentTime;
      const osc = ctx.createOscillator();
      const gain = ctx.createGain();
      osc.type = type;
      osc.frequency.value = freq;
      gain.gain.setValueAtTime(volume, now);
      gain.gain.exponentialRampToValueAtTime(0.0001, now + duration / 1000);
      osc.connect(gain);
      gain.connect(ctx.destination);
      osc.start(now);
      osc.stop(now + duration / 1000);
    }

    function resumeIfNeeded() {
      if (ctx && ctx.state === "suspended") ctx.resume();
    }

    const playClick = () => playTone(360, 90, "square", 0.08);
    const playSuccess = () => playTone(880, 180, "sine", 0.12);
    const playError = () => playTone(220, 200, "sawtooth", 0.12);
    const playSelect = () => playTone(520, 120, "triangle", 0.1);

    document.querySelectorAll(".btn-simulado, button[type='submit'], a.btn-simulado").forEach((el) => {
      el.addEventListener("click", () => {
        resumeIfNeeded();
        playClick();
      });
    });

    document.querySelectorAll("input[name='alternativa_id']").forEach((el) => {
      el.addEventListener("change", () => {
        resumeIfNeeded();
        playSelect();
      });
    });

    {% if feedback %}
    (() => {
      const modoAtual = "{{ mode|default:'PROVA' }}";
      if (modoAtual === "ESTUDO") {
        const acertou = {{ feedback.is_correct|yesno:"true,false" }};
        resumeIfNeeded();
        acertou ? playSuccess() : playError();
      }
    })();
    {% endif %}
  })();
</script>
<div vw class="enabled">
  <div vw-access-button class="active"></div>
  <div vw-plugin-wrapper>
    <div class="vw-plugin-top-wrapper"></div>
  </div>
</div>
<script src="https://vlibras.gov.br/app/vlibras-plugin.js"></script>
<script>
  new window.VLibras.Widget('https://vlibras.gov.br/app');
</script>
