{% load static %}

<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="utf-8">
    <title>Configurar Simulado</title>

    <!-- CSS do simulado -->
    <link rel="stylesheet" href="{% static 'simulado/simulado.css' %}">
</head>

<body class="simulado-container">
    <div class="simulado-card">
        <div class="simulado-header">
            <div>
                <h1 class="simulado-title">Simulado</h1>
                <p class="simulado-subtitle">Monte o treino escolhendo curso, módulo e filtros.</p>
            </div>

            <div class="simulado-quick">
                <button
                    type="button"
                    id="btn-inicio-rapido"
                    class="btn-rapido"
                    data-curso-id="{{ quick_curso_id|default_if_none:'' }}"
                    data-form-id="form-inicio-rapido"
                    {% if not quick_curso_id or not inicio_rapido.habilitado %}
                        disabled
                        title="{{ inicio_rapido.tooltip|default:'Curso padrão não encontrado' }}"
                    {% endif %}
                >
                    {{ inicio_rapido.label|default:"Início rápido" }}
                </button>
                <p class="simulado-quick-hint">{{ inicio_rapido.hint|default_if_none:"" }}</p>

                <!-- FORM DEDICADO DO INÍCIO RÁPIDO (POST) -->
                <form id="form-inicio-rapido" method="post" action="{% url 'simulado:iniciar' %}" class="is-hidden">
                    {% csrf_token %}
                    <input type="hidden" name="curso_id" value="{{ quick_curso_id|default_if_none:'' }}">
                    <input type="hidden" name="modulo_id" value="">
                    <input type="hidden" name="modo" value="{{ quick_filters.modo }}">
                    <input type="hidden" name="dificuldade" value="{{ quick_filters.dificuldade }}">
                    <input type="hidden" name="com_imagem" value="{{ quick_filters.com_imagem|yesno:'1,0' }}">
                    <input type="hidden" name="so_placas" value="{{ quick_filters.so_placas|yesno:'1,0' }}">
                    <input type="hidden" name="qtd" value="{{ quick_filters.qtd }}">
                </form>
            </div>
        </div>

        <div class="simulado-grid">
            <!-- FORM PRINCIPAL DE CONFIG -->
            <form method="post" action="{% url 'simulado:iniciar' %}" id="simulado-form" class="simulado-form">
                {% csrf_token %}

                <div class="form-grid">
                    <div class="form-group">
                        <label for="curso_id">Curso</label>
                        <select name="curso_id" id="curso_id" required>
                            <option value="">Selecione o curso...</option>
                            {% for c in cursos %}
                                <option value="{{ c.id }}">{{ c.nome }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="modulo_id">Módulo</label>
                        <select name="modulo_id" id="modulo_id" disabled>
                            <option value="">Todos os módulos</option>
                        </select>
                    </div>

                    <!-- NOVO: MODO (PROVA / ESTUDO) -->
                    <div class="form-group">
                        <label for="modo">Modo</label>
                        <select name="modo" id="modo">
                            <option value="PROVA" {% if simulado_defaults.modo == "PROVA" %}selected{% endif %}>Prova (sem feedback imediato)</option>
                            <option value="ESTUDO" {% if simulado_defaults.modo == "ESTUDO" %}selected{% endif %}>Estudo (com feedback imediato)</option>
                        </select>
                        <p class="field-hint">
                            Prova: você responde e vê o resultado no final. Estudo: mostra se acertou logo após responder.
                        </p>
                    </div>

                    <div class="form-group">
                        <label for="dificuldade">Dificuldade</label>
                        <select name="dificuldade" id="dificuldade">
                            <option value="" {% if not simulado_defaults.dificuldade %}selected{% endif %}>Misturado</option>
                            <option value="FACIL" {% if simulado_defaults.dificuldade == "FACIL" %}selected{% endif %}>Fácil</option>
                            <option value="INTERMEDIARIO" {% if simulado_defaults.dificuldade == "INTERMEDIARIO" %}selected{% endif %}>Intermediário</option>
                            <option value="DIFICIL" {% if simulado_defaults.dificuldade == "DIFICIL" %}selected{% endif %}>Difícil</option>
                        </select>

                    </div>

                    <div class="form-group form-group--full check-group">
                        <label>
                            <input type="checkbox" name="com_imagem" id="com_imagem" value="1" {% if simulado_defaults.com_imagem %}checked{% endif %}>
                            Somente questões com imagem
                        </label>

                        <label>
                            <input type="checkbox" name="so_placas" id="so_placas" value="1" {% if simulado_defaults.so_placas %}checked{% endif %}>
                            Somente questões de placas
                        </label>
                    </div>

                    <div class="form-group form-group--short">
                        <label for="qtd">Quantidade de questões</label>
                        <input
                            type="number"
                            name="qtd"
                            id="qtd"
                            value="{{ simulado_defaults.qtd }}"
                            min="{{ simulado_limits.qtd_min }}"
                            max="{{ simulado_limits.qtd_max }}"
                            required
                        >
                    </div>
                </div>

                <div class="form-actions">
                    <button type="submit" id="btn-iniciar" disabled>
                        Iniciar Simulado
                    </button>

                    <button type="button" id="btn-limpar" disabled>
                        Limpar filtros
                    </button>
                </div>
            </form>

            <!-- PAINEL DE STATS -->
            <aside id="stats-panel" class="stats-panel" aria-live="polite">
                <h3>Disponibilidade</h3>

                <p id="stats_hint" class="stats-hint"></p>
                <p id="stats_error" class="stats-error is-hidden"></p>

                <ul class="stats-list">
                    <li>
                        <span class="stats-label">Total disponível</span>
                        <span id="stat-total" class="stats-value">—</span>
                    </li>
                    <li>
                        <span class="stats-label">Com imagem</span>
                        <span id="stat-imagem" class="stats-value">—</span>
                    </li>
                    <li>
                        <span class="stats-label">Placas</span>
                        <span id="stat-placas" class="stats-value">—</span>
                    </li>
                </ul>

                <h4>Por dificuldade</h4>
                <ul class="stats-list stats-list--cols">
                    <li>
                        <span class="stats-label">Fácil</span>
                        <span id="stat-facil" class="stats-value">—</span>
                    </li>
                    <li>
                        <span class="stats-label">Intermediário</span>
                        <span id="stat-intermediario" class="stats-value">—</span>
                    </li>
                    <li>
                        <span class="stats-label">Difícil</span>
                        <span id="stat-dificil" class="stats-value">—</span>
                    </li>
                </ul>
            </aside>
        </div>
    </div>

    <!-- ========================= -->
    <!-- JS DO SIMULADO (AJAX) -->
    <!-- ========================= -->
    <script id="simulado-config" type="application/json">
        {{ simulado_config_json|safe }}
    </script>
    <script>
        window.SIMULADO_ENDPOINTS = {
            modulos: "{% url 'simulado:api_modulos' %}",
            stats: "{% url 'simulado:api_stats' %}",
        };
    </script>
    <script src="{% static 'simulado/simulado.js' %}"></script>
</body>
</html>
