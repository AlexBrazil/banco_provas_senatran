{% load static %}

<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Configurar Simulado</title>

    <!-- CSS do simulado -->
    <link rel="stylesheet" href="{% static 'simulado/simulado.css' %}">
    <link rel="stylesheet" href="{% static 'simulado/scroll-hint.css' %}">
</head>

<body class="simulado-container simulado-container--center">
    <div class="simulado-card">
        <div class="simulado-header">
            <div>
                <h1 class="simulado-title">Simulado</h1>
                <p class="simulado-subtitle">Monte o treino escolhendo curso, módulo e filtros.</p>
            </div>
            <div>
                <a class="btn-simulado" href="{% url 'simulado:inicio' %}">Voltar ao início</a>
            </div>
        </div>

        <div class="simulado-grid">
            <!-- FORM PRINCIPAL DE CONFIG -->
            <form method="post" action="{% url 'simulado:iniciar' %}" id="simulado-form" class="simulado-form">
                {% csrf_token %}

                {% if plano_status and plano_status.ativo %}
                    <div class="form-group form-group--full">
                        <h3>Seu plano</h3>
                        <ul class="stats-list">
                            <li>
                                <span class="stats-label">Plano</span>
                                <span class="stats-value">{{ plano_status.nome }}</span>
                            </li>
                            {% if plano_status.ilimitado %}
                                <li>
                                    <span class="stats-label">Limite</span>
                                    <span class="stats-value">Ilimitado</span>
                                </li>
                            {% else %}
                                <li>
                                    <span class="stats-label">Limite</span>
                                    <span class="stats-value">
                                        {{ plano_status.limite_qtd }} / {{ plano_status.limite_periodo_label }}
                                    </span>
                                </li>
                                <li>
                                    <span class="stats-label">Usados</span>
                                    <span class="stats-value">{{ plano_status.usos }}</span>
                                </li>
                                <li>
                                    <span class="stats-label">Restantes</span>
                                    <span class="stats-value">{{ plano_status.restantes }}</span>
                                </li>
                            {% endif %}
                            {% if plano_status.janela_fim %}
                                <li>
                                    <span class="stats-label">Janela atual</span>
                                    <span class="stats-value">ate {{ plano_status.janela_fim|date:"d/m/Y H:i" }}</span>
                                </li>
                            {% endif %}
                            {% if plano_status.valid_until %}
                                <li>
                                    <span class="stats-label">Valido ate</span>
                                    <span class="stats-value">{{ plano_status.valid_until|date:"d/m/Y H:i" }}</span>
                                </li>
                            {% endif %}
                        </ul>
                        {% if plano_bloqueado %}
                            <p class="stats-error">Limite de simulados atingido para esta janela.</p>
                            <p class="stats-msg is-warn">Para alterar o plano, contate o administrador.</p>
                        {% endif %}
                    </div>
                {% endif %}

                <div class="form-grid">
                    <div class="form-group">
                        <label for="curso_id">Curso</label>
                        <select name="curso_id" id="curso_id" required>
                            <option value="">Selecione o curso...</option>
                            {% for c in cursos %}
                                <option value="{{ c.id }}" {% if quick_curso_id and c.id == quick_curso_id %}selected{% endif %}>{{ c.nome }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="modulo_id">Módulo</label>
                        <select name="modulo_id" id="modulo_id" disabled>
                            <option value="">Todos os módulos</option>
                        </select>
                    </div>

                    <!-- NOVO: MODO (PROVA / ESTUDO) -->
                    <div class="form-group">
                        <label for="modo">Modo</label>
                        <select name="modo" id="modo">
                            <option value="PROVA" {% if simulado_defaults.modo == "PROVA" %}selected{% endif %}>Prova (sem feedback imediato)</option>
                            <option value="ESTUDO" {% if simulado_defaults.modo == "ESTUDO" %}selected{% endif %}>Estudo (com feedback imediato)</option>
                        </select>
                        <p class="field-hint">
                            Prova: você responde e vê o resultado no final. Estudo: mostra se acertou logo após responder.
                        </p>
                    </div>

                    <div class="form-group">
                        <label for="dificuldade">Dificuldade</label>
                        <select name="dificuldade" id="dificuldade">
                            <option value="" {% if not simulado_defaults.dificuldade %}selected{% endif %}>Misturado</option>
                            <option value="FACIL" {% if simulado_defaults.dificuldade == "FACIL" %}selected{% endif %}>Fácil</option>
                            <option value="INTERMEDIARIO" {% if simulado_defaults.dificuldade == "INTERMEDIARIO" %}selected{% endif %}>Intermediário</option>
                            <option value="DIFICIL" {% if simulado_defaults.dificuldade == "DIFICIL" %}selected{% endif %}>Difícil</option>
                        </select>

                    </div>

                    <div class="form-group form-group--full check-group">
                        <label>
                            <input type="checkbox" name="com_imagem" id="com_imagem" value="1" {% if simulado_defaults.com_imagem %}checked{% endif %}>
                            Somente questões com imagem
                        </label>

                        <label>
                            <input type="checkbox" name="so_placas" id="so_placas" value="1" {% if simulado_defaults.so_placas %}checked{% endif %}>
                            Somente questões de placas
                        </label>
                    </div>

                    <div class="form-group form-group--short">
                        <label for="qtd">Quantidade de questões</label>
                        <input
                            type="number"
                            name="qtd"
                            id="qtd"
                            value="{{ simulado_defaults.qtd }}"
                            min="{{ simulado_limits.qtd_min }}"
                            max="{{ simulado_limits.qtd_max }}"
                            required
                        >
                    </div>
                </div>

                <div class="form-actions">
                    <button type="submit" id="btn-iniciar" disabled>
                        Iniciar Simulado
                    </button>

                    <button type="button" id="btn-limpar" disabled>
                        Limpar filtros
                    </button>
                </div>
            </form>

            <!-- PAINEL DE STATS -->
            <aside id="stats-panel" class="stats-panel" aria-live="polite">
                <h3>Disponibilidade</h3>

                <p id="stats_hint" class="stats-hint"></p>
                <p id="stats_error" class="stats-error is-hidden"></p>

                <ul class="stats-list">
                    <li>
                        <span class="stats-label">Total disponível</span>
                        <span id="stat-total" class="stats-value">—</span>
                    </li>
                    <li>
                        <span class="stats-label">Com imagem</span>
                        <span id="stat-imagem" class="stats-value">—</span>
                    </li>
                    <li>
                        <span class="stats-label">Placas</span>
                        <span id="stat-placas" class="stats-value">—</span>
                    </li>
                </ul>

                <h4>Por dificuldade</h4>
                <ul class="stats-list stats-list--cols">
                    <li>
                        <span class="stats-label">Fácil</span>
                        <span id="stat-facil" class="stats-value">—</span>
                    </li>
                    <li>
                        <span class="stats-label">Intermediário</span>
                        <span id="stat-intermediario" class="stats-value">—</span>
                    </li>
                    <li>
                        <span class="stats-label">Difícil</span>
                        <span id="stat-dificil" class="stats-value">—</span>
                    </li>
                </ul>
            </aside>
        </div>
    </div>

    <!-- ========================= -->
    <!-- JS DO SIMULADO (AJAX) -->
    <!-- ========================= -->
    <script id="simulado-config" type="application/json">
        {{ simulado_config_json|safe }}
    </script>
    <script>
        window.SIMULADO_ENDPOINTS = {
            modulos: "{% url 'simulado:api_modulos' %}",
            stats: "{% url 'simulado:api_stats' %}",
        };
    </script>
    <script src="{% static 'simulado/simulado.js' %}"></script>
    <script>
      (() => {
        const AudioCtx = window.AudioContext || window.webkitAudioContext;
        const ctx = AudioCtx ? new AudioCtx() : null;

        function playTone(freq, duration, type = "sine", volume = 0.08) {
          if (!ctx) return;
          const now = ctx.currentTime;
          const osc = ctx.createOscillator();
          const gain = ctx.createGain();
          osc.type = type;
          osc.frequency.value = freq;
          gain.gain.setValueAtTime(volume, now);
          gain.gain.exponentialRampToValueAtTime(0.0001, now + duration / 1000);
          osc.connect(gain);
          gain.connect(ctx.destination);
          osc.start(now);
          osc.stop(now + duration / 1000);
        }

        function resumeIfNeeded() {
          if (ctx && ctx.state === "suspended") ctx.resume();
        }

        const playClick = () => playTone(360, 90, "square", 0.08);

        document.querySelectorAll("button, .btn-simulado, a.btn-simulado").forEach((el) => {
          el.addEventListener("click", () => {
            resumeIfNeeded();
            playClick();
          });
        });
      })();
    </script>
    <div class="scroll-hint__sentinel" aria-hidden="true"></div>
    <script src="{% static 'simulado/scroll-hint.js' %}"></script>
</body>
</html>
